# 저장 프로시저 (Stored Procedure)
<br>

## 1. 저장 프로시저 SP(Stored Procedure)란?

일련의 SQL문장을 선언해서 MySQL에 저장하고, 해당 SQL문을 함수처럼 사용하는 것. 함수처럼 호출하여 편하게 사용할 수 있다.

SQL문법의 함수(Function)와 아주 유사한 느낌이다. 하지만 우리가 아는 SQL함수와는 차이가 있다.

**함수(Function) : 클라이언트에서 처리, 리턴값 필수, 리턴값 하나만 반환가능**

**프로시저(Procedure) : 서버로 보내서 처리, 리턴값 선택, 리턴값 여러개 반환가능**

속도면에서는 프로시저가 더 빠른 성능을 보인다.

때문에 프로시저 같은 경우 실행, 처리를 할 때 주로 사용되고, 함수는 간단한 계산이나 수치 결과를 나타낼 때 주로 사용한다.
<br>
<br>

## 2. 저장 프로시저 생성 / 호출

🔸 **저장 프로시저 생성**

예) 고객 테이블에서 고객이름순으로 조회한 정보를 저장 프로시저로 생성

```sql
DELIMITER $$
CREATE PROCEDURE GetCustomers()
BEGIN
	SELECT customerName, city, state, postalCode, country
    FROM customers
    ORDER BY customerName;
END $$
DELIMITER ;
```
<br>

🔹 **DELIMITER ?**

저장 프로시저 내부에 사용하는 SQL문은 일반 SQL문이기때문에 세미콜론(;)으로 문장을 끝맺어야 한다.

이 때, 저장 프로시저 작성이 완료되지 않았음에도 SQL문이 실행되는 위험을 막기 위해 구분자(;)를 다른 구분자로 바꿔주어야하는데 이 때 사용하는 명령어가 DELIMITER 이다.

➡

저장 프로시저 생성 전에 구분자(DELIMITER)를 $$ 으로 바꿔주고 프로시저 작성이 끝났을 때 END $$ 로 저장 프로시저의 끝을 알려준다. 마지막으로 구분자를 원래대로 되돌리기 위해 구분자(DELIMITER)를 세미콜론(;)으로 바꿔준다.
<br>
<br>

🔸 **저장 프로시저 호출**

```sql
CALL GetCustomers();
```

저장 프로시저를 호출하면, 데이터베이스 카달로그에서 프로시저 이름을 찾아 명령코드(SQL문)를 컴파일하고 메모리 공간(cache)에 저장하고, 프로시저를 실행시킨다.

그리고 같은 세션에서 동일한 저장 프로시저를 한번 더 호출하면, 컴파일과정을 다시 거치지 않고 기존의 저장 프로시저를 캐시(cache)에서 불러온다.

저장 프로시저는 위 예시처럼 단순 select문으로 작성할 수도 있지만, 매개변수(파라미터)에 개별 value값을 넣어 원하는 결과를 조회할 수도 있다.

또한, IF, CASE 그리고 LOOP 같은 제어 흐름 문장을 사용하여 보다 향상된 SQL 코드문 작성도 가능하며 프로시저 내에서 다른 저장프로시저를 호출하여 사용할 수도 있다.
<br>
<br>

### **💾 사용 이점**

1. **서버/클라이언트 네트워크 트래픽 감소**

프로시저 명령은 단일 일괄 처리 코드로 실행됨

2. **보안 강화**

개별 개체 수준에서 사용 권한을 부여할 필요가 없으며 보안 계층이 간소화 됨.

3. **코드 재사용**

프리시저에서 코드를 캡슐화하여서 같은 코드를 다시 작성할 필요가 없음

4. **간편한 유지 관리**

본 데이터베이스의 모든 변경 내용에 대해 프로시저만 업데이트하면 됨

5. **성능 향상**

처음 실행될 때 컴파일되며 이후 실행에 다시 사용되는 실행 계획을 생성함.

---

### **💾** 사용 단점

1. **유지보수가 어렵다.**

유지보수를 하는 사람과 개발한 사람이 다르다면 유지보수가 어렵다. 

데이터 분석이 까다롭고 하나의 프로시저를 여러 곳에서 사용했을 경우도 분석이 어렵다.

2. **DB 확장이 힘들다.**

서버의 수를 늘려야할 때, DB의 수를 늘리는 것이 어렵다. 또한,  DB 교체는 거의 불가능하다.
